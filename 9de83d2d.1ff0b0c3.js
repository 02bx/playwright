(window.webpackJsonp=window.webpackJsonp||[]).push([[228],{286:function(e,a,t){"use strict";t.r(a),t.d(a,"frontMatter",(function(){return o})),t.d(a,"metadata",(function(){return c})),t.d(a,"rightToc",(function(){return l})),t.d(a,"default",(function(){return p}));var n=t(2),i=t(6),r=(t(0),t(399)),o={id:"ci",title:"Continuous Integration"},c={unversionedId:"ci",id:"version-1.1.0/ci",isDocsHomePage:!1,title:"Continuous Integration",description:"Playwright tests can be executed to run on your CI environments. To simplify this, we have created sample configurations for common CI providers that can be used to bootstrap your setup.",source:"@site/versioned_docs/version-1.1.0/ci.md",slug:"/ci",permalink:"/playwright/docs/1.1.0/ci",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/versioned_docs/version-1.1.0/ci.md",version:"1.1.0",sidebar:"version-1.1.0/docs",previous:{title:"Navigation and loading",permalink:"/playwright/docs/1.1.0/loading"},next:{title:"Test Runners",permalink:"/playwright/docs/1.1.0/test-runners"}},l=[{value:"CI configurations",id:"ci-configurations",children:[{value:"GitHub Actions",id:"github-actions",children:[]},{value:"Docker",id:"docker",children:[]},{value:"Azure Pipelines",id:"azure-pipelines",children:[]},{value:"Travis CI",id:"travis-ci",children:[]},{value:"CircleCI",id:"circleci",children:[]},{value:"AppVeyor",id:"appveyor",children:[]}]},{value:"Caching browsers",id:"caching-browsers",children:[]},{value:"Debugging browser launches",id:"debugging-browser-launches",children:[]}],s={rightToc:l};function p(e){var a=e.components,t=Object(i.a)(e,["components"]);return Object(r.a)("wrapper",Object(n.a)({},s,t,{components:a,mdxType:"MDXLayout"}),Object(r.a)("p",null,"Playwright tests can be executed to run on your CI environments. To simplify this, we have created sample configurations for common CI providers that can be used to bootstrap your setup."),Object(r.a)("ul",null,Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#ci-configurations"}),"CI configurations"),Object(r.a)("ul",{parentName:"li"},Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#github-actions"}),"GitHub Actions")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#docker"}),"Docker")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#azure-pipelines"}),"Azure Pipelines")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#travis-ci"}),"Travis CI")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#circleci"}),"CircleCI")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#appveyor"}),"AppVeyor")))),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#caching-browsers"}),"Caching browsers"),Object(r.a)("ul",{parentName:"li"},Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#exception-nodemodules-are-cached"}),"Exception: ",Object(r.a)("inlineCode",{parentName:"a"},"node_modules")," are cached")),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#directories-to-cache"}),"Directories to cache")))),Object(r.a)("li",{parentName:"ul"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#debugging-browser-launches"}),"Debugging browser launches"))),Object(r.a)("p",null,"Broadly, configuration on CI involves ",Object(r.a)("strong",{parentName:"p"},"ensuring system dependencies")," are in place, ",Object(r.a)("strong",{parentName:"p"},"installing Playwright and browsers")," (typically with ",Object(r.a)("inlineCode",{parentName:"p"},"npm install"),"), and ",Object(r.a)("strong",{parentName:"p"},"running tests")," (typically with ",Object(r.a)("inlineCode",{parentName:"p"},"npm test"),"). Windows and macOS build agents do not require any additional system dependencies. Linux build agents can require additional dependencies, depending on the Linux distribution."),Object(r.a)("h2",{id:"ci-configurations"},"CI configurations"),Object(r.a)("h3",{id:"github-actions"},"GitHub Actions"),Object(r.a)("p",null,"The ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/microsoft/playwright-github-action"}),"Playwright GitHub Action")," can be used to run Playwright tests on GitHub Actions."),Object(r.a)("pre",null,Object(r.a)("code",Object(n.a)({parentName:"pre"},{className:"language-yml"}),"steps:\n  - uses: microsoft/playwright-github-action@v1\n  - name: Run your tests\n    run: npm test\n")),Object(r.a)("p",null,"We run ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/.github/workflows/tests.yml"}),"our tests")," on GitHub Actions, across a matrix of 3 platforms (Windows, Linux, macOS) and 3 browsers (Chromium, Firefox, WebKit)."),Object(r.a)("h3",{id:"docker"},"Docker"),Object(r.a)("p",null,"We have a ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/playwright/docs/1.1.0/docker/README"}),"pre-built Docker image")," which can either be used directly, or as a reference to update your existing Docker definitions."),Object(r.a)("p",null,"Suggested configuration"),Object(r.a)("ol",null,Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},"By default, Docker runs a container with a ",Object(r.a)("inlineCode",{parentName:"p"},"/dev/shm")," shared memory space 64MB.\nThis is ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/c0b/chrome-in-docker/issues/1"}),"typically too small")," for Chromium\nand will cause Chromium to crash when rendering large pages. To fix, run the container with\n",Object(r.a)("inlineCode",{parentName:"p"},"docker run --shm-size=1gb")," to increase the size of ",Object(r.a)("inlineCode",{parentName:"p"},"/dev/shm"),". Since Chromium 65, this is no\nlonger necessary. Instead, launch the browser with the ",Object(r.a)("inlineCode",{parentName:"p"},"--disable-dev-shm-usage")," flag:"),Object(r.a)("pre",{parentName:"li"},Object(r.a)("code",Object(n.a)({parentName:"pre"},{className:"language-js"}),"const browser = await playwright.chromium.launch({\n  args: ['--disable-dev-shm-usage']\n});\n")),Object(r.a)("p",{parentName:"li"},"This will write shared memory files into ",Object(r.a)("inlineCode",{parentName:"p"},"/tmp")," instead of ",Object(r.a)("inlineCode",{parentName:"p"},"/dev/shm"),". See\n",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://bugs.chromium.org/p/chromium/issues/detail?id=736452"}),"crbug.com/736452")," for more details.")),Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},"Using ",Object(r.a)("inlineCode",{parentName:"p"},"--ipc=host")," is also recommended when using Chromium\u2014without it Chromium can run out of memory\nand crash. Learn more about this option in ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://docs.docker.com/engine/reference/run/#ipc-settings---ipc"}),"Docker docs"),".")),Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},"Seeing other weird errors when launching Chromium? Try running your container\nwith ",Object(r.a)("inlineCode",{parentName:"p"},"docker run --cap-add=SYS_ADMIN")," when developing locally. Since the Dockerfile\nadds a ",Object(r.a)("inlineCode",{parentName:"p"},"pwuser")," user as a non-privileged user, it may not have all the necessary privileges.")),Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/Yelp/dumb-init"}),"dumb-init")," is worth checking out if you're\nexperiencing a lot of zombies Chromium processes sticking around. There's special\ntreatment for processes with PID=1, which makes it hard to terminate Chromium\nproperly in some cases (e.g. in Docker)."))),Object(r.a)("h3",{id:"azure-pipelines"},"Azure Pipelines"),Object(r.a)("p",null,"For Windows or macOS agents, no additional configuration required, just install Playwright and run your tests."),Object(r.a)("p",null,"For Linux agents, refer to ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/playwright/docs/1.1.0/docker/README"}),"our Docker setup")," to see additional dependencies that need to be installed."),Object(r.a)("h3",{id:"travis-ci"},"Travis CI"),Object(r.a)("p",null,"We run our tests on Travis CI over a Linux agent (Ubuntu 18.04). Use our ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/.travis.yml"}),"Travis configuration")," to see list of additional dependencies to be installed."),Object(r.a)("p",null,"Suggested configuration"),Object(r.a)("ol",null,Object(r.a)("li",{parentName:"ol"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"http://man7.org/linux/man-pages/man7/user_namespaces.7.html"}),"User namespace cloning"),"\nshould be enabled to support proper sandboxing"),Object(r.a)("li",{parentName:"ol"},Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"https://en.wikipedia.org/wiki/Xvfb"}),"xvfb")," should be launched in order to run\nChromium in non-headless mode (e.g. to test Chrome Extensions)"),Object(r.a)("li",{parentName:"ol"},"If your project does not have ",Object(r.a)("inlineCode",{parentName:"li"},"package-lock.json"),", Travis would be auto-caching\n",Object(r.a)("inlineCode",{parentName:"li"},"node_modules")," directory. If you run ",Object(r.a)("inlineCode",{parentName:"li"},"npm install")," (instead of ",Object(r.a)("inlineCode",{parentName:"li"},"npm ci"),"), it is\npossible that the browser binaries are not downloaded. Fix this with ",Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"#exception-nodemodules-are-cached"}),"these steps")," outlined below.")),Object(r.a)("p",null,"To sum up, your ",Object(r.a)("inlineCode",{parentName:"p"},".travis.yml")," might look like this:"),Object(r.a)("pre",null,Object(r.a)("code",Object(n.a)({parentName:"pre"},{className:"language-yml"}),'language: node_js\ndist: bionic\naddons:\n  apt:\n    packages:\n    # This is required to run chromium\n    - libgbm1\n    # These are required to run webkit\n    - libwoff1\n    - libopus0\n    - libwebp6\n    - libwebpdemux2\n    - libenchant1c2a\n    - libgudev-1.0-0\n    - libsecret-1-0\n    - libhyphen0\n    - libgdk-pixbuf2.0-0\n    - libegl1\n    - libgles2\n    - libevent-2.1-6\n    - libnotify4\n    - libxslt1.1\n    - libvpx5\n    # For headful execution\n    - xvfb\n\n# allow headful tests\nbefore_install:\n  # Enable user namespace cloning\n  - "sysctl kernel.unprivileged_userns_clone=1"\n  # Launch XVFB\n  - "export DISPLAY=:99.0"\n  - "sh -e /etc/init.d/xvfb start"\n')),Object(r.a)("h3",{id:"circleci"},"CircleCI"),Object(r.a)("p",null,"We run our tests on CircleCI, with our ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/playwright/docs/1.1.0/docker/README"}),"pre-built Docker image"),". Use our ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/.circleci/config.yml"}),"CircleCI configuration")," to create your own. Running Playwright smoothly on CircleCI requires the following steps:"),Object(r.a)("ol",null,Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},"Use the pre-built ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/playwright/docs/1.1.0/docker/README"}),"Docker image")," in your config like so:"),Object(r.a)("pre",{parentName:"li"},Object(r.a)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),"docker:\n  - image: aslushnikov/playwright:bionic\n    environment:\n      NODE_ENV: development # Needed if playwright is in `devDependencies`\n"))),Object(r.a)("li",{parentName:"ol"},Object(r.a)("p",{parentName:"li"},"If you\u2019re using Playwright through Jest, then you may encounter an error spawning child processes:"),Object(r.a)("pre",{parentName:"li"},Object(r.a)("code",Object(n.a)({parentName:"pre"},{}),"[00:00.0]  jest args: --e2e --spec --max-workers=36\nError: spawn ENOMEM\n   at ChildProcess.spawn (internal/child_process.js:394:11)\n")),Object(r.a)("p",{parentName:"li"},"This is likely caused by Jest autodetecting the number of processes on the entire machine (",Object(r.a)("inlineCode",{parentName:"p"},"36"),") rather than the number allowed to your container (",Object(r.a)("inlineCode",{parentName:"p"},"2"),"). To fix this, set ",Object(r.a)("inlineCode",{parentName:"p"},"jest --maxWorkers=2")," in your test command."))),Object(r.a)("h3",{id:"appveyor"},"AppVeyor"),Object(r.a)("p",null,"We run our tests on Windows agents in AppVeyor. Use our ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/.appveyor.yml"}),"AppVeyor configuration")," to create your own."),Object(r.a)("h2",{id:"caching-browsers"},"Caching browsers"),Object(r.a)("p",null,"By default, Playwright downloads browser binaries when the Playwright NPM package\nis installed. The NPM packages have a ",Object(r.a)("inlineCode",{parentName:"p"},"postinstall")," hook that downloads the browser\nbinaries. This behavior can be ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"/playwright/docs/1.1.0/installation"}),"customized with environment variables"),"."),Object(r.a)("p",null,"Caching browsers on CI is ",Object(r.a)("strong",{parentName:"p"},"strictly optional"),": The ",Object(r.a)("inlineCode",{parentName:"p"},"postinstall")," hooks should\nexecute and download the browser binaries on every run."),Object(r.a)("h4",{id:"exception-node_modules-are-cached"},"Exception: ",Object(r.a)("inlineCode",{parentName:"h4"},"node_modules")," are cached"),Object(r.a)("p",null,"Most CI providers cache the ",Object(r.a)("a",Object(n.a)({parentName:"p"},{href:"https://docs.npmjs.com/cli-commands/cache.html"}),"npm-cache"),"\ndirectory (located at ",Object(r.a)("inlineCode",{parentName:"p"},"$HOME/.npm"),"). If your CI pipelines caches the ",Object(r.a)("inlineCode",{parentName:"p"},"node_modules"),"\ndirectory and you run ",Object(r.a)("inlineCode",{parentName:"p"},"npm install")," (instead of ",Object(r.a)("inlineCode",{parentName:"p"},"npm ci"),"), the default configuration\n",Object(r.a)("strong",{parentName:"p"},"will not work"),". This is because the ",Object(r.a)("inlineCode",{parentName:"p"},"npm install")," step will find the NPM\npackage on disk, and not execute the ",Object(r.a)("inlineCode",{parentName:"p"},"postinstall")," step."),Object(r.a)("blockquote",null,Object(r.a)("p",{parentName:"blockquote"},"Travis CI automatically caches ",Object(r.a)("inlineCode",{parentName:"p"},"node_modules")," if your repo does not have a\n",Object(r.a)("inlineCode",{parentName:"p"},"package-lock.json")," file.")),Object(r.a)("p",null,"This behavior can be fixed with one of the following approaches:"),Object(r.a)("ol",null,Object(r.a)("li",{parentName:"ol"},"Move to caching ",Object(r.a)("inlineCode",{parentName:"li"},"$HOME/.npm")," or the npm-cache directory. (This is the default\nbehavior in most CI providers.)"),Object(r.a)("li",{parentName:"ol"},"Set ",Object(r.a)("inlineCode",{parentName:"li"},"PLAYWRIGHT_BROWSERS_PATH=0")," as the environment variable before running\n",Object(r.a)("inlineCode",{parentName:"li"},"npm install"),". This will download the browser binaries in the ",Object(r.a)("inlineCode",{parentName:"li"},"node_modules"),"\ndirectory and cache them with the package code. See ",Object(r.a)("a",Object(n.a)({parentName:"li"},{href:"/playwright/docs/1.1.0/installation"}),"installation docs"),"."),Object(r.a)("li",{parentName:"ol"},"Cache the browser binaries, with the steps below.")),Object(r.a)("h4",{id:"directories-to-cache"},"Directories to cache"),Object(r.a)("p",null,"With the default behavior, Playwright downloads the browser binaries in the following\ndirectories:"),Object(r.a)("ul",null,Object(r.a)("li",{parentName:"ul"},Object(r.a)("inlineCode",{parentName:"li"},"%USERPROFILE%\\AppData\\Local\\ms-playwright")," on Windows"),Object(r.a)("li",{parentName:"ul"},Object(r.a)("inlineCode",{parentName:"li"},"~/Library/Caches/ms-playwright")," on MacOS"),Object(r.a)("li",{parentName:"ul"},Object(r.a)("inlineCode",{parentName:"li"},"~/.cache/ms-playwright")," on Linux")),Object(r.a)("p",null,"To cache the browser downloads between CI runs, cache this location in your CI\nconfiguration, against a hash of the Playwright version."),Object(r.a)("h2",{id:"debugging-browser-launches"},"Debugging browser launches"),Object(r.a)("p",null,"Playwright supports the ",Object(r.a)("inlineCode",{parentName:"p"},"DEBUG")," environment variable to output debug logs during execution. Setting it to ",Object(r.a)("inlineCode",{parentName:"p"},"pw:browser*")," is helpful while debugging ",Object(r.a)("inlineCode",{parentName:"p"},"Error: Failed to launch browser")," errors."),Object(r.a)("pre",null,Object(r.a)("code",Object(n.a)({parentName:"pre"},{}),"DEBUG=pw:browser* npm run test\n")))}p.isMDXComponent=!0},399:function(e,a,t){"use strict";t.d(a,"a",(function(){return d}));var n=t(0),i=t.n(n);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function o(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function c(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?o(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function l(e,a){if(null==e)return{};var t,n,i=function(e,a){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||(i[t]=e[t]);return i}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=i.a.createContext({}),p=function(e){var a=i.a.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):c(c({},a),e)),t},b={inlineCode:"code",wrapper:function(e){var a=e.children;return i.a.createElement(i.a.Fragment,{},a)}},u=i.a.forwardRef((function(e,a){var t=e.components,n=e.mdxType,r=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=p(t),d=n,h=u["".concat(o,".").concat(d)]||u[d]||b[d]||r;return t?i.a.createElement(h,c(c({ref:a},s),{},{components:t})):i.a.createElement(h,c({ref:a},s))}));function d(e,a){var t=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var r=t.length,o=new Array(r);o[0]=u;var c={};for(var l in a)hasOwnProperty.call(a,l)&&(c[l]=a[l]);c.originalType=e,c.mdxType="string"==typeof e?e:n,o[1]=c;for(var s=2;s<r;s++)o[s]=t[s];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);